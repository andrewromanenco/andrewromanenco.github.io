(this["webpackJsonppaxos-reactjs"]=this["webpackJsonppaxos-reactjs"]||[]).push([[0],{68:function(e,t,s){},69:function(e,t,s){},73:function(e,t,s){"use strict";s.r(t);var n=s(6),a=s(0),o=s.n(a),i=s(10),r=s.n(i),c=(s(68),s(40)),l=s(30),u=s(7),h=s(8),d=s(24),p=s(15),f=s(14),b=(s(69),function(){function e(t,s){if(Object(u.a)(this,e),"string"!==typeof t&&t instanceof String)throw new Error("toName must be a string");if("string"!==typeof s&&s instanceof String)throw new Error("fromName must be a string");this.to=t,this.from=s,this.op=this.constructor.name}return Object(h.a)(e,[{key:"execute",value:function(e,t){throw new Error("Must override this method")}}]),e}()),m=function(){function e(){Object(u.a)(this,e),this.nodes=[],this.brokenLinks="[]"}return Object(h.a)(e,[{key:"registerNode",value:function(e){this.nodes.forEach((function(t){if(t.name===e.name)throw new Error("Name already registered: "+t.name)})),this.nodes.push(e)}},{key:"validateBrokenLinks",value:function(){try{var e=JSON.parse(this.brokenLinks);if(!Array.isArray(e))return console.log("Broken list must be an array of pairs"),!1;var t=!1;if(e.forEach((function(e){Array.isArray(e)||(t=!0,console.error('Elements of block list must by lists like ["A", "B"] but got '+JSON.stringify(e)))})),t)return!1}catch(s){return console.log("Bad json for broken list, must be json, e.g. '[]' for empty"),!1}return!0}},{key:"sendMessage",value:function(e){if(!(e instanceof b))throw Error("The message to send is not an instance of MessageOp: "+JSON.stringify(e));var t=JSON.parse(this.brokenLinks),s=!1;if(t.forEach((function(t){(t[0]===e.to&&t[1]===e.from||t[1]===e.to&&t[0]===e.from)&&(s=!0)})),s)console.log("Message is dropped due to block rule.");else{var n=!1;if(this.nodes.forEach((function(t){t.name===e.to&&(t.scheduleOp(e),n=!0)})),!n)throw new Error("Failed to deliver message: "+JSON.stringify(e))}}},{key:"findByRole",value:function(e,t){var s=[];if(this.nodes.forEach((function(t){t.hasRole(e)&&s.push(t)})),t)for(var n,a,o=s.length;0!==o;)a=Math.floor(Math.random()*o),n=s[o-=1],s[o]=s[a],s[a]=n;return s}},{key:"setBrokenLinks",value:function(e){this.brokenLinks=e}}]),e}(),g=s(53),j=s(26),v=function(){function e(t,s){Object(u.a)(this,e),this.name=t,s?Array.isArray(s)?this.roles=s:this.roles=[s]:this.roles=[],this.queue=[],this.messageBroker=null,this.state={}}return Object(h.a)(e,[{key:"bind",value:function(e){return this.messageBroker=e,e.registerNode(this),this}},{key:"scheduleOp",value:function(e){var t=Object(l.a)(this.queue);t.push(e),this.queue=t}},{key:"scheduleOpOnTop",value:function(e){var t=Object(l.a)(this.queue);t.unshift(e),this.queue=t}},{key:"tick",value:function(e){if(!this.messageBroker)throw new Error("Message broker is not set for "+this.name);0!==this.queue.length&&this.queue.shift().execute(this,e)}},{key:"hasScheduledOps",value:function(){return this.queue.length>0}},{key:"hasRole",value:function(e){return this.roles.includes(e)}}]),e}(),k=function(){function e(t){if(Object(u.a)(this,e),!Array.isArray(t))throw new Error("The parameter has to be a list");t.forEach((function(e){if(!(e instanceof b))throw new Error("Can only deliver MessageOp instances: "+JSON.stringify(e))})),this.messagesToDeliver=t}return Object(h.a)(e,[{key:"execute",value:function(e,t){this.messagesToDeliver.forEach((function(t){console.log("Sent ".concat(t.op," to ").concat(t.to)),e.messageBroker.sendMessage(t)}))}}]),e}(),O=function(e){Object(p.a)(s,e);var t=Object(f.a)(s);function s(e,n,a,o){var i;return Object(u.a)(this,s),(i=t.call(this,e,n)).paxosInstanceId=a,i.value=o,i}return Object(h.a)(s,[{key:"execute",value:function(e,t){console.log("Learner ".concat(e.name," notified about value ").concat(this.value," at index ").concat(this.paxosInstanceId));var s=e.state.paxos[this.paxosInstanceId];s.gotFinalValue(this.from,this.value)?(console.log("Got final value ".concat(s.finalValue," for ").concat(s.instanceId)),e.logFinalValue(s.instanceId,s.finalValue)):console.log("Not yet")}}]),s}(b),x=function(e){Object(p.a)(s,e);var t=Object(f.a)(s);function s(e,n,a,o,i){var r;return Object(u.a)(this,s),(r=t.call(this,e,n)).proposalNumber=a,r.paxosInstanceId=o,r.value=i,r}return Object(h.a)(s,[{key:"execute",value:function(e,t){var s=this,n=e.state.paxos[this.paxosInstanceId];n.isBehind(this.proposalNumber,this.from)||n.isSame(this.proposalNumber,this.from)?(console.log("Accept is legit, accepting"),n.accept(this.proposalNumber,this.from,this.value),e.messageBroker.findByRole("paxos",!0).forEach((function(t){var a=new O(t.name,e.name,n.instanceId,s.value),o=new k([a]);e.scheduleOp(o)}))):console.log("Already past, ignoring accept.")}}]),s}(b),y=function(e){Object(p.a)(s,e);var t=Object(f.a)(s);function s(e,n,a,o,i){var r;return Object(u.a)(this,s),(r=t.call(this,e,n)).proposalNumber=a,r.paxosInstanceId=o,r.acceptedValue=i,r}return Object(h.a)(s,[{key:"execute",value:function(e,t){var s=this;console.log("Got promise from ".concat(this.from," on ").concat(this.proposalNumber," for instance ").concat(this.paxosInstanceId));var n=e.state.paxos[this.paxosInstanceId];console.assert(n),n.promises[this.from]=this.acceptedValue;var a=Object.keys(n.promises).length;if(a===n.majority){var o=n.pickLargestAcceptedValue();console.log("Largest promise ".concat(o)),o||(o=e.state.valueToSend),console.log("Got majority (".concat(n.majority,") and the value to send is ").concat(o)),e.messageBroker.findByRole("paxos",!0).forEach((function(t){console.log("Scheduling accept for ".concat(t.name," value ").concat(o," in ").concat(s.proposalNumber,"@").concat(n.instanceId));var a=new x(t.name,e.name,s.proposalNumber,n.instanceId,o),i=new k([a]);e.scheduleOp(i)}))}a>n.majority&&console.log("Past majority already, ignoring")}}]),s}(b),S=function(){function e(t,s){Object(u.a)(this,e),this.instanceId=t,this.majority=Math.floor(s/2)+1,this.proposalNumber=1,this.promisedProposalNumber=0,this.promisedProposalTo=0,this.promises={},this.acceptedValue={},this.acceptedByOthers={},this.finalValue=null}return Object(h.a)(e,[{key:"updatePromise",value:function(e,t){if(!this.isBehind(e,t))throw new Error("Should never happen, as there is a check earlier");this.promisedProposalNumber=e,this.promisedProposalTo=t}},{key:"isBehind",value:function(e,t){return e>this.promisedProposalNumber||e===this.promisedProposalNumber&&t>this.promisedProposalTo}},{key:"isSame",value:function(e,t){return e===this.promisedProposalNumber&&t===this.promisedProposalTo}},{key:"accept",value:function(e,t,s){if(!this.isBehind(e,t)&&!this.isSame(e,t))throw new Error("Should never happen, as there is a check earlier");this.acceptedValue={proposalNumber:e,proposedBy:t,value:s}}},{key:"gotFinalValue",value:function(e,t){if(this.finalValue)return!0;this.acceptedByOthers[e]=t;var s=null,n=1;return Object.entries(this.acceptedByOthers).forEach((function(e){var t=Object(c.a)(e,2),a=(t[0],t[1]);s===a?n++:1===n?(s=a,n=1):n--})),n===this.majority&&(console.assert(!this.finalValue||this.finalValue===s),this.finalValue=s,!0)}},{key:"pickLargestAcceptedValue",value:function(){var e=null,t=0,s="";return Object.entries(this.promises).forEach((function(n){var a=Object(c.a)(n,2),o=(a[0],a[1]);(o.proposalNumber>t||o.proposalNumber===t&&o.proposedBy>s)&&(e=o.value,t=o.proposalNumber,s=o.proposedBy)})),e}}]),e}(),N=function(e){Object(p.a)(s,e);var t=Object(f.a)(s);function s(e,n,a,o){var i;return Object(u.a)(this,s),(i=t.call(this,e,n)).proposalNumber=a,i.paxosInstanceId=o,i}return Object(h.a)(s,[{key:"execute",value:function(e,t){var s;console.log("Got prepare from ".concat(this.from," for instance ").concat(this.paxosInstanceId," and proposalNum ").concat(this.proposalNumber)),e.state.paxos[this.paxosInstanceId]?s=e.state.paxos[this.paxosInstanceId]:(s=new S(this.paxosInstanceId,3),e.state.paxos[this.paxosInstanceId]=s),s.isBehind(this.proposalNumber,this.from)?(s.updatePromise(this.proposalNumber,this.from),e.messageBroker.sendMessage(new y(this.from,e.name,s.promisedProposalNumber,s.instanceId,s.acceptedValue))):console.log("Too old, current is ".concat(s.promisedProposalNumber,", ignoring"))}}]),s}(b),w=function(e){Object(p.a)(s,e);var t=Object(f.a)(s);function s(e,n,a,o){var i;return Object(u.a)(this,s),(i=t.call(this,e,n)).value=a,i.status=o,i}return Object(h.a)(s,[{key:"execute",value:function(e,t){e.state.progress[this.value]=this.status}}]),s}(b),B=function(e){Object(p.a)(s,e);var t=Object(f.a)(s);function s(e){var n;return Object(u.a)(this,s),(n=t.call(this,e,"paxos")).queue=[],n.state.log=[],n.state.paxos={},n}return Object(h.a)(s,[{key:"scheduleOp",value:function(e){Object(g.a)(Object(j.a)(s.prototype),"scheduleOp",this).call(this,e)}},{key:"addToLog",value:function(e){var t=this,s=this.state.log.length;console.log("".concat(this.name," asked to add ").concat(e," to log at index ").concat(s)),this.state.valueToSend=e,this.state.valueToSendAtIndex=s;var n=new S(s,3);this.state.paxos[s]=n,this.messageBroker.findByRole("paxos",!0).forEach((function(e){var s=new N(e.name,t.name,n.proposalNumber,n.instanceId),a=new k([s]);t.scheduleOp(a)}))}},{key:"logFinalValue",value:function(e,t){var s=this.state.log[e];if(s){if(s!==t)throw new Error("Got ".concat(t," at [").concat(e,"], while expecting ").concat(s))}else this.state.log[e]=t,console.log("Learned about ".concat(t," for index ").concat(e)),this.state.valueToSendAtIndex===e&&(t===this.state.valueToSend?this.messageBroker.sendMessage(new w("client",this.name,this.state.valueToSend,"accepted")):this.messageBroker.sendMessage(new w("client",this.name,this.state.valueToSend,"not accepted")),this.state.valueToSend=null,this.state.valueToSendAtIndex=0)}}]),s}(v),T=function(){function e(){Object(u.a)(this,e),this.op=this.constructor.name}return Object(h.a)(e,[{key:"execute",value:function(e,t){var s,n=e.messageBroker.findByRole("paxos",!0);if(e.state.values.forEach((function(t){s||e.state.progress[t]&&("accepted"===e.state.progress[t]||e.state.progress[t].startsWith("in-progress"))||(s=t)})),s){for(var a=!1,o=0;o<n.length;o++)if(!n[o].state.valueToSend){n[o].addToLog(s),e.state.progress[s]="in-progress:"+n[o].name,a=!0;break}a||(e.state.progress[s]="nodes-busy")}else console.log("No more values")}}]),e}(),I=function(e){Object(p.a)(s,e);var t=Object(f.a)(s);function s(){var e;return Object(u.a)(this,s),(e=t.call(this,"client","client")).state.values=[1,2,3,4,5,6,7,8,9],e.state.progress={},e}return Object(h.a)(s,[{key:"sendNext",value:function(){console.log("Init send command"),this.scheduleOp(new T)}}]),s}(v),E=s(109),C=function(){function e(){Object(u.a)(this,e)}return Object(h.a)(e,[{key:"create",value:function(e){this.clientNode=new I,this.clientNode.bind(e),new B("PaxosNode-A").bind(e),new B("PaxosNode-B").bind(e),new B("PaxosNode-C").bind(e),this.send=this.send.bind(this)}},{key:"controlUI",value:function(){return Object(n.jsxs)("div",{children:[Object(n.jsx)("h1",{children:"Multi Paxos"}),Object(n.jsx)("div",{children:"Open debug console to see log message. Keep clicking Tick for step-by-step progress."}),Object(n.jsx)("div",{children:"On SendMessage the client proposes a not-yet committed number to a random paxos node. The node initates a paxos instance to write the number to the log and report the status to the client. Basically, click SendMessage and keep clicking Tick."}),Object(n.jsx)(E.a,{variant:"contained",onClick:this.send,children:"Send message"})]})}},{key:"send",value:function(){this.clientNode.sendNext()}}]),e}(),L=s(114),A=s(118),P=s(117),V=s(113),M=s(115),q=s(116),J=s(122),F=s(123),R=s(121),G=function(){function e(t){Object(u.a)(this,e),this.sleep=t}return Object(h.a)(e,[{key:"execute",value:function(t,s){this.sleep>1?(console.log("Still sleeping for "+(this.sleep-1)),t.scheduleOpOnTop(new e(this.sleep-1))):console.log("Slept enough")}}]),e}(),D=function(e){Object(p.a)(s,e);var t=Object(f.a)(s);function s(e){var n;if(Object(u.a)(this,s),(n=t.call(this,e)).messageBroker=new m,n.example=new C,n.example.create(n.messageBroker),0===n.messageBroker.nodes.length)throw new Error("No nodes to work with");return n.state={nodes:Object(l.a)(n.messageBroker.nodes),tick:1,brokenLinks:"[]",sleepTicks:"0",nodeToSleep:n.messageBroker.nodes[0].name},n.tick=n.tick.bind(Object(d.a)(n)),n.handleBrokenLinksChange=n.handleBrokenLinksChange.bind(Object(d.a)(n)),n.handleSleepTicksChange=n.handleSleepTicksChange.bind(Object(d.a)(n)),n.handleNodeToSleepChange=n.handleNodeToSleepChange.bind(Object(d.a)(n)),n.addSleepToNode=n.addSleepToNode.bind(Object(d.a)(n)),n}return Object(h.a)(s,[{key:"tick",value:function(){var e=this;if(this.messageBroker.validateBrokenLinks()){console.log("Start with tick "+this.state.tick);var t=[];this.state.nodes.forEach((function(e){e.hasScheduledOps()&&t.push(e)})),t.forEach((function(t){console.log("Tick on "+t.name),t.tick(e.state.tick)})),console.log("Done with tick "+this.state.tick),console.log("------------------------");var s=this.state.tick+1,n=Object(l.a)(this.messageBroker.nodes);this.setState({tick:s,nodes:n})}}},{key:"addSleepToNode",value:function(){var e=this;this.state.nodes.forEach((function(t){t.name===e.state.nodeToSleep&&(console.log("Added sleep to "+t.name),t.scheduleOpOnTop(new G(parseInt(e.state.sleepTicks))))})),this.setState({nodes:Object(l.a)(this.state.nodes)})}},{key:"handleBrokenLinksChange",value:function(e){this.messageBroker.setBrokenLinks(e.target.value),this.setState({brokenLinks:e.target.value})}},{key:"handleSleepTicksChange",value:function(e){this.setState({sleepTicks:e.target.value})}},{key:"handleNodeToSleepChange",value:function(e){this.setState({nodeToSleep:e.target.value})}},{key:"render",value:function(){return Object(n.jsxs)("div",{children:[this.example.controlUI(),Object(n.jsxs)(E.a,{variant:"contained",onClick:this.tick,children:["Tick (",this.state.tick,")"]}),Object(n.jsx)("br",{}),Object(n.jsx)(V.a,{children:Object(n.jsxs)(L.a,{"aria-label":"simple table",children:[Object(n.jsx)(M.a,{children:Object(n.jsxs)(q.a,{children:[Object(n.jsx)(P.a,{children:"Node name"}),Object(n.jsx)(P.a,{children:"Incoming queue"}),Object(n.jsx)(P.a,{children:"State"})]})}),Object(n.jsx)(A.a,{children:this.state.nodes.map((function(e){return Object(n.jsxs)(q.a,{children:[Object(n.jsx)(P.a,{children:e.name}),Object(n.jsx)(P.a,{children:e.queue.map((function(t,s){return Object(n.jsx)("div",{children:JSON.stringify(t)},e.name+t.op+s)}))}),Object(n.jsx)(P.a,{children:Object.entries(e.state).map((function(t){var s=Object(c.a)(t,2),a=s[0],o=s[1];return Object(n.jsx)("div",{children:Object(n.jsxs)("pre",{children:[a,": ",JSON.stringify(o,null,2)]})},e.name+a)}))})]},e.name)}))})]})}),Object(n.jsx)(J.a,{label:'Json list of pairs of broken list. E.g. [["A", "B"], ["A", "C"]] messages b/n A<->B and A<->C will be dropped.',value:this.state.brokenLinks,onChange:this.handleBrokenLinksChange,multiline:!0,fullWidth:!0,rows:"10"}),Object(n.jsx)("br",{}),Object(n.jsx)(J.a,{label:"Sleep length in ticks",value:this.state.sleepTicks,onChange:this.handleSleepTicksChange,multiline:!1,fullWidth:!1,rows:"1"}),Object(n.jsx)(R.a,{value:this.state.nodeToSleep,onChange:this.handleNodeToSleepChange,children:this.state.nodes.map((function(e){return Object(n.jsx)(F.a,{value:e.name,children:e.name},e.name)}))}),Object(n.jsxs)(E.a,{variant:"contained",onClick:this.addSleepToNode,children:["Add sleep to ",this.state.nodeToSleep]}),Object(n.jsx)("br",{})]})}}]),s}(o.a.Component),W=function(e){e&&e instanceof Function&&s.e(3).then(s.bind(null,125)).then((function(t){var s=t.getCLS,n=t.getFID,a=t.getFCP,o=t.getLCP,i=t.getTTFB;s(e),n(e),a(e),o(e),i(e)}))};r.a.render(Object(n.jsx)(o.a.StrictMode,{children:Object(n.jsx)(D,{})}),document.getElementById("root")),W()}},[[73,1,2]]]);
//# sourceMappingURL=main.7d0b0444.chunk.js.map