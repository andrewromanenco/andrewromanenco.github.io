(this["webpackJsonppaxos-reactjs"]=this["webpackJsonppaxos-reactjs"]||[]).push([[0],{65:function(e,t,n){},66:function(e,t,n){},70:function(e,t,n){"use strict";n.r(t);var s=n(6),o=n(0),a=n.n(o),i=n(8),r=n.n(i),c=(n(65),n(39)),h=n(29),l=n(11),u=n(12),d=n(24),f=n(22),b=n(20),j=(n(66),function(){function e(t,n){if(Object(l.a)(this,e),"string"!==typeof t&&t instanceof String)throw new Error("toName must be a string");if("string"!==typeof n&&n instanceof String)throw new Error("fromName must be a string");this.to=t,this.from=n,this.op=this.constructor.name}return Object(u.a)(e,[{key:"execute",value:function(e,t){throw new Error("Must override this method")}}]),e}()),k=function(){function e(){Object(l.a)(this,e),this.nodes=[],this.brokenLinks="[]"}return Object(u.a)(e,[{key:"registerNode",value:function(e){this.nodes.forEach((function(t){if(t.name===e.name)throw new Error("Name already registered: "+t.name)})),this.nodes.push(e)}},{key:"validateBrokenLinks",value:function(){try{var e=JSON.parse(this.brokenLinks);if(!Array.isArray(e))return console.log("Broken list must be an array of pairs"),!1;var t=!1;if(e.forEach((function(e){Array.isArray(e)||(t=!0,console.error('Elements of block list must by lists like ["A", "B"] but got '+JSON.stringify(e)))})),t)return!1}catch(n){return console.log("Bad json for broken list, must be json, e.g. '[]' for empty"),!1}return!0}},{key:"sendMessage",value:function(e){if(!(e instanceof j))throw Error("The message to send is not an instance of MessageOp: "+JSON.stringify(e));var t=JSON.parse(this.brokenLinks),n=!1;if(t.forEach((function(t){(t[0]===e.to&&t[1]===e.from||t[1]===e.to&&t[0]===e.from)&&(n=!0)})),n)console.log("Message is dropped due to block rule.");else{var s=!1;if(this.nodes.forEach((function(t){t.name===e.to&&(t.scheduleOp(e),s=!0)})),!s)throw new Error("Failed to deliver message: "+JSON.stringify(e))}}},{key:"findByRole",value:function(e,t){var n=[];if(this.nodes.forEach((function(t){t.hasRole(e)&&n.push(t)})),t)for(var s,o,a=n.length;0!==a;)o=Math.floor(Math.random()*a),s=n[a-=1],n[a]=n[o],n[o]=s;return n}},{key:"setBrokenLinks",value:function(e){this.brokenLinks=e}}]),e}(),O=function(){function e(t,n){Object(l.a)(this,e),this.name=t,n?Array.isArray(n)?this.roles=n:this.roles=[n]:this.roles=[],this.queue=[],this.messageBroker=null,this.state={}}return Object(u.a)(e,[{key:"bind",value:function(e){return this.messageBroker=e,e.registerNode(this),this}},{key:"scheduleOp",value:function(e){var t=Object(h.a)(this.queue);t.push(e),this.queue=t}},{key:"scheduleOpOnTop",value:function(e){var t=Object(h.a)(this.queue);t.unshift(e),this.queue=t}},{key:"tick",value:function(e){if(!this.messageBroker)throw new Error("Message broker is not set for "+this.name);0!==this.queue.length&&this.queue.shift().execute(this,e)}},{key:"hasScheduledOps",value:function(){return this.queue.length>0}},{key:"hasRole",value:function(e){return this.roles.includes(e)}}]),e}(),g=function(e){Object(f.a)(n,e);var t=Object(b.a)(n);function n(){return Object(l.a)(this,n),t.apply(this,arguments)}return Object(u.a)(n,[{key:"execute",value:function(e,t){e.gotBeatFrom(this.from,t)}}]),n}(j),p=function(){function e(t){if(Object(l.a)(this,e),!Array.isArray(t))throw new Error("The parameter has to be a list");t.forEach((function(e){if(!(e instanceof j))throw new Error("Can only deliver MessageOp instances: "+JSON.stringify(e))})),this.messagesToDeliver=t}return Object(u.a)(e,[{key:"execute",value:function(e,t){this.messagesToDeliver.forEach((function(t){console.log("Sent ".concat(t.op," to ").concat(t.to)),e.messageBroker.sendMessage(t)}))}}]),e}(),v=function(){function e(){Object(l.a)(this,e),this.op=this.constructor.name}return Object(u.a)(e,[{key:"execute",value:function(e,t){if(t>=e.state.nextBeatNotBefore){e.state.nextBeatNotBefore+=10;var n=e.messageBroker.findByRole("watcher");console.log("Schedule beat delivery to ".concat(n.length," watchers")),n.forEach((function(t){var n=new g(t.name,e.name),s=new p([n]);e.scheduleOp(s)}))}else console.log("Alive, but not the beat time yet");e.scheduleOp(this)}}]),e}(),m=function(e){Object(f.a)(n,e);var t=Object(b.a)(n);function n(e){var s;return Object(l.a)(this,n),(s=t.call(this,e)).queue=[new v],s.state={nextBeatNotBefore:Math.floor(Math.random()*Math.floor(5))},s}return n}(O),y=function(){function e(){Object(l.a)(this,e),this.op=this.constructor.name}return Object(u.a)(e,[{key:"execute",value:function(e,t){Object.entries(e.state).forEach((function(n){var s=Object(c.a)(n,2),o=s[0],a=Object(c.a)(s[1],2),i=a[0],r=(a[1],t-i);r>15&&(console.log("Server ".concat(o," is OFFLINE. No beat for ").concat(r," ticks.")),e.state[o][1]="OFFLINE")})),e.scheduleOp(this)}}]),e}(),w=function(e){Object(f.a)(n,e);var t=Object(b.a)(n);function n(e){var s;return Object(l.a)(this,n),(s=t.call(this,e)).roles=["watcher"],s.queue=[new y],s}return Object(u.a)(n,[{key:"gotBeatFrom",value:function(e,t){console.log("Recevied a beat from "+e),this.state[e]=[t,"ALIVE"]}}]),n}(O),S=function(){function e(){Object(l.a)(this,e)}return Object(u.a)(e,[{key:"create",value:function(e){new m("Server-A").bind(e),new m("Server-B").bind(e),new m("Server-C").bind(e),new w("Watcher-X").bind(e),new w("Watcher-Y").bind(e),new w("Watcher-Z").bind(e)}},{key:"controlUI",value:function(){return Object(s.jsxs)("div",{children:[Object(s.jsx)("h1",{children:"Heart beat"}),Object(s.jsx)("div",{children:"Open debug console to see log message. Keep clicking Tick for step-by-step progress."}),Object(s.jsx)("div",{children:"Three nodes send heart beats to three watchers. Use channel block feature or add sleep to ServerNodes to see how watchers change their state."}),Object(s.jsx)("div",{children:"Watchers mark servers Offline if no heartbeat for 15 ticks."})]})}}]),e}(),x=n(112),B=n(116),T=n(115),N=n(111),E=n(113),C=n(114),L=n(107),A=n(120),M=n(121),q=n(119),F=function(){function e(t){Object(l.a)(this,e),this.sleep=t}return Object(u.a)(e,[{key:"execute",value:function(t,n){this.sleep>1?(console.log("Still sleeping for "+(this.sleep-1)),t.scheduleOpOnTop(new e(this.sleep-1))):console.log("Slept enough")}}]),e}(),J=function(e){Object(f.a)(n,e);var t=Object(b.a)(n);function n(e){var s;if(Object(l.a)(this,n),(s=t.call(this,e)).messageBroker=new k,s.example=new S,s.example.create(s.messageBroker),0===s.messageBroker.nodes.length)throw new Error("No nodes to work with");return s.state={nodes:Object(h.a)(s.messageBroker.nodes),tick:1,brokenLinks:"[]",sleepTicks:"0",nodeToSleep:s.messageBroker.nodes[0].name},s.tick=s.tick.bind(Object(d.a)(s)),s.handleBrokenLinksChange=s.handleBrokenLinksChange.bind(Object(d.a)(s)),s.handleSleepTicksChange=s.handleSleepTicksChange.bind(Object(d.a)(s)),s.handleNodeToSleepChange=s.handleNodeToSleepChange.bind(Object(d.a)(s)),s.addSleepToNode=s.addSleepToNode.bind(Object(d.a)(s)),s}return Object(u.a)(n,[{key:"tick",value:function(){var e=this;if(this.messageBroker.validateBrokenLinks()){console.log("Start with tick "+this.state.tick);var t=[];this.state.nodes.forEach((function(e){e.hasScheduledOps()&&t.push(e)})),t.forEach((function(t){console.log("Tick on "+t.name),t.tick(e.state.tick)})),console.log("Done with tick "+this.state.tick),console.log("------------------------");var n=this.state.tick+1,s=Object(h.a)(this.messageBroker.nodes);this.setState({tick:n,nodes:s})}}},{key:"addSleepToNode",value:function(){var e=this;this.state.nodes.forEach((function(t){t.name===e.state.nodeToSleep&&(console.log("Added sleep to "+t.name),t.scheduleOpOnTop(new F(parseInt(e.state.sleepTicks))))})),this.setState({nodes:Object(h.a)(this.state.nodes)})}},{key:"handleBrokenLinksChange",value:function(e){this.messageBroker.setBrokenLinks(e.target.value),this.setState({brokenLinks:e.target.value})}},{key:"handleSleepTicksChange",value:function(e){this.setState({sleepTicks:e.target.value})}},{key:"handleNodeToSleepChange",value:function(e){this.setState({nodeToSleep:e.target.value})}},{key:"render",value:function(){return Object(s.jsxs)("div",{children:[this.example.controlUI(),Object(s.jsxs)(L.a,{variant:"contained",onClick:this.tick,children:["Tick (",this.state.tick,")"]}),Object(s.jsx)("br",{}),Object(s.jsx)(N.a,{children:Object(s.jsxs)(x.a,{"aria-label":"simple table",children:[Object(s.jsx)(E.a,{children:Object(s.jsxs)(C.a,{children:[Object(s.jsx)(T.a,{children:"Node name"}),Object(s.jsx)(T.a,{children:"Incoming queue"}),Object(s.jsx)(T.a,{children:"State"})]})}),Object(s.jsx)(B.a,{children:this.state.nodes.map((function(e){return Object(s.jsxs)(C.a,{children:[Object(s.jsx)(T.a,{children:e.name}),Object(s.jsx)(T.a,{children:e.queue.map((function(t,n){return Object(s.jsx)("div",{children:JSON.stringify(t)},e.name+t.op+n)}))}),Object(s.jsx)(T.a,{children:Object.entries(e.state).map((function(t){var n=Object(c.a)(t,2),o=n[0],a=n[1];return Object(s.jsx)("div",{children:Object(s.jsxs)("pre",{children:[o,": ",JSON.stringify(a,null,2)]})},e.name+o)}))})]},e.name)}))})]})}),Object(s.jsx)(A.a,{label:'Json list of pairs of broken list. E.g. [["A", "B"], ["A", "C"]] messages b/n A<->B and A<->C will be dropped.',value:this.state.brokenLinks,onChange:this.handleBrokenLinksChange,multiline:!0,fullWidth:!0,rows:"10"}),Object(s.jsx)("br",{}),Object(s.jsx)(A.a,{label:"Sleep length in ticks",value:this.state.sleepTicks,onChange:this.handleSleepTicksChange,multiline:!1,fullWidth:!1,rows:"1"}),Object(s.jsx)(q.a,{value:this.state.nodeToSleep,onChange:this.handleNodeToSleepChange,children:this.state.nodes.map((function(e){return Object(s.jsx)(M.a,{value:e.name,children:e.name},e.name)}))}),Object(s.jsxs)(L.a,{variant:"contained",onClick:this.addSleepToNode,children:["Add sleep to ",this.state.nodeToSleep]}),Object(s.jsx)("br",{})]})}}]),n}(a.a.Component),I=function(e){e&&e instanceof Function&&n.e(3).then(n.bind(null,123)).then((function(t){var n=t.getCLS,s=t.getFID,o=t.getFCP,a=t.getLCP,i=t.getTTFB;n(e),s(e),o(e),a(e),i(e)}))};r.a.render(Object(s.jsx)(a.a.StrictMode,{children:Object(s.jsx)(J,{})}),document.getElementById("root")),I()}},[[70,1,2]]]);
//# sourceMappingURL=main.6cce2809.chunk.js.map