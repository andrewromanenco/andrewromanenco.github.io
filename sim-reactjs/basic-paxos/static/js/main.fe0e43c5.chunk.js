(this["webpackJsonppaxos-reactjs"]=this["webpackJsonppaxos-reactjs"]||[]).push([[0],{65:function(e,t,n){},66:function(e,t,n){},70:function(e,t,n){"use strict";n.r(t);var o=n(6),s=n(0),a=n.n(s),r=n(9),i=n.n(r),c=(n(65),n(46)),l=n(29),u=n(7),h=n(12),p=n(24),d=n(15),b=n(14),f=(n(66),function(){function e(t,n){if(Object(u.a)(this,e),"string"!==typeof t&&t instanceof String)throw new Error("toName must be a string");if("string"!==typeof n&&n instanceof String)throw new Error("fromName must be a string");this.to=t,this.from=n,this.op=this.constructor.name}return Object(h.a)(e,[{key:"execute",value:function(e,t){throw new Error("Must override this method")}}]),e}()),m=function(){function e(){Object(u.a)(this,e),this.nodes=[],this.brokenLinks="[]"}return Object(h.a)(e,[{key:"registerNode",value:function(e){this.nodes.forEach((function(t){if(t.name===e.name)throw new Error("Name already registered: "+t.name)})),this.nodes.push(e)}},{key:"validateBrokenLinks",value:function(){try{var e=JSON.parse(this.brokenLinks);if(!Array.isArray(e))return console.log("Broken list must be an array of pairs"),!1;var t=!1;if(e.forEach((function(e){Array.isArray(e)||(t=!0,console.error('Elements of block list must by lists like ["A", "B"] but got '+JSON.stringify(e)))})),t)return!1}catch(n){return console.log("Bad json for broken list, must be json, e.g. '[]' for empty"),!1}return!0}},{key:"sendMessage",value:function(e){if(!(e instanceof f))throw Error("The message to send is not an instance of MessageOp: "+JSON.stringify(e));var t=JSON.parse(this.brokenLinks),n=!1;if(t.forEach((function(t){(t[0]===e.to&&t[1]===e.from||t[1]===e.to&&t[0]===e.from)&&(n=!0)})),n)console.log("Message is dropped due to block rule.");else{var o=!1;if(this.nodes.forEach((function(t){t.name===e.to&&(t.scheduleOp(e),o=!0)})),!o)throw new Error("Failed to deliver message: "+JSON.stringify(e))}}},{key:"findByRole",value:function(e,t){var n=[];if(this.nodes.forEach((function(t){t.hasRole(e)&&n.push(t)})),t)for(var o,s,a=n.length;0!==a;)s=Math.floor(Math.random()*a),o=n[a-=1],n[a]=n[s],n[s]=o;return n}},{key:"setBrokenLinks",value:function(e){this.brokenLinks=e}}]),e}(),j=function(){function e(t,n){Object(u.a)(this,e),this.name=t,n?Array.isArray(n)?this.roles=n:this.roles=[n]:this.roles=[],this.queue=[],this.messageBroker=null,this.state={}}return Object(h.a)(e,[{key:"bind",value:function(e){return this.messageBroker=e,e.registerNode(this),this}},{key:"scheduleOp",value:function(e){var t=Object(l.a)(this.queue);t.push(e),this.queue=t}},{key:"scheduleOpOnTop",value:function(e){var t=Object(l.a)(this.queue);t.unshift(e),this.queue=t}},{key:"tick",value:function(e){if(!this.messageBroker)throw new Error("Message broker is not set for "+this.name);0!==this.queue.length&&this.queue.shift().execute(this,e)}},{key:"hasScheduledOps",value:function(){return this.queue.length>0}},{key:"hasRole",value:function(e){return this.roles.includes(e)}}]),e}(),g=function(){function e(t){Object(u.a)(this,e),this.sleep=t}return Object(h.a)(e,[{key:"execute",value:function(t,n){this.sleep>1?(console.log("Still sleeping for "+(this.sleep-1)),t.scheduleOpOnTop(new e(this.sleep-1))):console.log("Slept enough")}}]),e}(),k=function(){function e(t){if(Object(u.a)(this,e),!Array.isArray(t))throw new Error("The parameter has to be a list");t.forEach((function(e){if(!(e instanceof f))throw new Error("Can only deliver MessageOp instances: "+JSON.stringify(e))})),this.messagesToDeliver=t}return Object(h.a)(e,[{key:"execute",value:function(e,t){this.messagesToDeliver.forEach((function(t){console.log("Sent ".concat(t.op," to ").concat(t.to)),e.messageBroker.sendMessage(t)}))}}]),e}(),O=function(e){Object(d.a)(n,e);var t=Object(b.a)(n);function n(e){var o;return Object(u.a)(this,n),(o=t.call(this,e,"acceptor")).state.proposalNumber=0,o.state.proposedBy="",o}return n}(j),v=function(e){Object(d.a)(n,e);var t=Object(b.a)(n);function n(e,o,s){var a;return Object(u.a)(this,n),(a=t.call(this,e,o)).value=s,a}return Object(h.a)(n,[{key:"execute",value:function(e,t){console.log("Learner ".concat(e.name," notified about value: ").concat(this.value)),e.state.acceptedValues[this.from]=this.value}}]),n}(f),y=function(e){Object(d.a)(n,e);var t=Object(b.a)(n);function n(e,o,s,a){var r;return Object(u.a)(this,n),(r=t.call(this,e,o)).proposalNumber=s,r.value=a,r}return Object(h.a)(n,[{key:"execute",value:function(e,t){var n=this;(console.log("Accepted check"),this.proposalNumber>e.state.proposalNumber||this.proposalNumber===e.state.proposalNumber&&this.from>=e.state.proposedBy)?(console.log("Accepting value: "+this.value),e.state.acceptedValue={proposalNumber:this.proposalNumber,poposedBy:this.from,value:this.value},e.messageBroker.findByRole("learner",!0).forEach((function(t){var o=new v(t.name,e.name,n.value),s=new k([o]);e.scheduleOp(s)}))):console.log("Got older accept, ignoring")}}]),n}(f),N=function(e){Object(d.a)(n,e);var t=Object(b.a)(n);function n(e,o,s,a){var r;return Object(u.a)(this,n),(r=t.call(this,e,o)).proposalNumber=s,r.alreadyAccepted=a,r}return Object(h.a)(n,[{key:"execute",value:function(e,t){var n=this;if(this.proposalNumber===e.state.proposalNumber){e.state.quorum[this.from]=[this.alreadyAccepted];var o=Math.floor(e.messageBroker.findByRole("learner").length/2)+1;if(Object.keys(e.state.quorum).length===o){console.log("Got the majority(".concat(o,"), sending accepts"));var s=null,a=0,r="";Object.entries(e.state.quorum).forEach((function(e){var t=Object(c.a)(e,2),n=(t[0],t[1]);n[0]&&(s?(n[0].proposalNumber>a||n[0].proposalNumber===a||n[0].proposedBy>r)&&(s=n[0].value,a=n[0].proposalNumber,r=n[0].proposedBy):s=n[0].value)})),s||(s=e.name+"/"+e.state.proposalNumber),console.log("The value to send: "+s),e.messageBroker.findByRole("acceptor").forEach((function(t){console.log("Scheduling accept for "+t.name);var o=new y(t.name,e.name,n.proposalNumber,s),a=new k([o]);e.scheduleOp(a)}))}else console.log("No majority(".concat(o,") yet"))}else console.log("Was expecting promise on ".concat(e.state.proposalNumber-1,", but got ").concat(this.proposalNumber,". Ignoring."))}}]),n}(f),w=function(e){Object(d.a)(n,e);var t=Object(b.a)(n);function n(e,o,s){var a;return Object(u.a)(this,n),(a=t.call(this,e,o)).proposalNumber=s,a}return Object(h.a)(n,[{key:"execute",value:function(e,t){console.assert(e instanceof O),this.proposalNumber>e.state.proposalNumber||this.proposalNumber===e.state.proposalNumber&&this.from>e.state.proposedBy?(console.log("Promising ".concat(this.proposalNumber," to ").concat(this.from)),e.state.proposalNumber=this.proposalNumber,e.state.proposedBy=this.from,e.messageBroker.sendMessage(new N(this.from,e.name,e.state.proposalNumber,e.state.acceptedValue))):console.log("Prepare is too old ".concat(this.proposalNumber," vs ").concat(e.state.proposalNumber,", and ").concat(this.from," vs ").concat(e.state.proposedBy,". Ignoring."))}}]),n}(f),x=function(){function e(){Object(u.a)(this,e),this.op=this.constructor.name}return Object(h.a)(e,[{key:"execute",value:function(e,t){var n=e.messageBroker.findByRole("acceptor",!0);console.log("Sending a proposal to ".concat(n.length," acceptors.")),n.forEach((function(t){var n=new w(t.name,e.name,e.state.proposalNumber+1),o=new k([n]);e.scheduleOp(new g(Math.floor(Math.random()*Math.floor(20)))),e.scheduleOp(o)})),e.state.proposalNumber=e.state.proposalNumber+1}}]),e}(),B=function(e){Object(d.a)(n,e);var t=Object(b.a)(n);function n(e){var o;return Object(u.a)(this,n),(o=t.call(this,e,"proposer")).queue=[new g(Math.floor(Math.random()*Math.floor(25))),new x],o.state.proposalNumber=0,o.state.quorum={},o}return n}(j),S=function(e){Object(d.a)(n,e);var t=Object(b.a)(n);function n(e){var o;return Object(u.a)(this,n),(o=t.call(this,e,"learner")).state.acceptedValues={},o}return n}(j),T=function(){function e(){Object(u.a)(this,e)}return Object(h.a)(e,[{key:"create",value:function(e){new B("Proposer-A").bind(e),new B("Proposer-B").bind(e),new B("Proposer-C").bind(e),new O("Acceptor-X").bind(e),new O("Acceptor-Y").bind(e),new O("Acceptor-Z").bind(e),new S("Learner-M").bind(e),new S("Learner-N").bind(e)}},{key:"controlUI",value:function(){return Object(o.jsxs)("div",{children:[Object(o.jsx)("h1",{children:"Basic Paxos"}),Object(o.jsx)("div",{children:"Open debug console to see log message. Keep clicking Tick for step-by-step progress."}),Object(o.jsx)("div",{children:"Proposers propose their names and learners see the eventual agreement."})]})}}]),e}(),E=n(112),C=n(116),A=n(115),L=n(111),M=n(113),q=n(114),J=n(107),P=n(120),I=n(121),R=n(119),F=function(e){Object(d.a)(n,e);var t=Object(b.a)(n);function n(e){var o;if(Object(u.a)(this,n),(o=t.call(this,e)).messageBroker=new m,o.example=new T,o.example.create(o.messageBroker),0===o.messageBroker.nodes.length)throw new Error("No nodes to work with");return o.state={nodes:Object(l.a)(o.messageBroker.nodes),tick:1,brokenLinks:"[]",sleepTicks:"0",nodeToSleep:o.messageBroker.nodes[0].name},o.tick=o.tick.bind(Object(p.a)(o)),o.handleBrokenLinksChange=o.handleBrokenLinksChange.bind(Object(p.a)(o)),o.handleSleepTicksChange=o.handleSleepTicksChange.bind(Object(p.a)(o)),o.handleNodeToSleepChange=o.handleNodeToSleepChange.bind(Object(p.a)(o)),o.addSleepToNode=o.addSleepToNode.bind(Object(p.a)(o)),o}return Object(h.a)(n,[{key:"tick",value:function(){var e=this;if(this.messageBroker.validateBrokenLinks()){console.log("Start with tick "+this.state.tick);var t=[];this.state.nodes.forEach((function(e){e.hasScheduledOps()&&t.push(e)})),t.forEach((function(t){console.log("Tick on "+t.name),t.tick(e.state.tick)})),console.log("Done with tick "+this.state.tick),console.log("------------------------");var n=this.state.tick+1,o=Object(l.a)(this.messageBroker.nodes);this.setState({tick:n,nodes:o})}}},{key:"addSleepToNode",value:function(){var e=this;this.state.nodes.forEach((function(t){t.name===e.state.nodeToSleep&&(console.log("Added sleep to "+t.name),t.scheduleOpOnTop(new g(parseInt(e.state.sleepTicks))))})),this.setState({nodes:Object(l.a)(this.state.nodes)})}},{key:"handleBrokenLinksChange",value:function(e){this.messageBroker.setBrokenLinks(e.target.value),this.setState({brokenLinks:e.target.value})}},{key:"handleSleepTicksChange",value:function(e){this.setState({sleepTicks:e.target.value})}},{key:"handleNodeToSleepChange",value:function(e){this.setState({nodeToSleep:e.target.value})}},{key:"render",value:function(){return Object(o.jsxs)("div",{children:[this.example.controlUI(),Object(o.jsxs)(J.a,{variant:"contained",onClick:this.tick,children:["Tick (",this.state.tick,")"]}),Object(o.jsx)("br",{}),Object(o.jsx)(L.a,{children:Object(o.jsxs)(E.a,{"aria-label":"simple table",children:[Object(o.jsx)(M.a,{children:Object(o.jsxs)(q.a,{children:[Object(o.jsx)(A.a,{children:"Node name"}),Object(o.jsx)(A.a,{children:"Incoming queue"}),Object(o.jsx)(A.a,{children:"State"})]})}),Object(o.jsx)(C.a,{children:this.state.nodes.map((function(e){return Object(o.jsxs)(q.a,{children:[Object(o.jsx)(A.a,{children:e.name}),Object(o.jsx)(A.a,{children:e.queue.map((function(t,n){return Object(o.jsx)("div",{children:JSON.stringify(t)},e.name+t.op+n)}))}),Object(o.jsx)(A.a,{children:Object.entries(e.state).map((function(t){var n=Object(c.a)(t,2),s=n[0],a=n[1];return Object(o.jsx)("div",{children:Object(o.jsxs)("pre",{children:[s,": ",JSON.stringify(a,null,2)]})},e.name+s)}))})]},e.name)}))})]})}),Object(o.jsx)(P.a,{label:'Json list of pairs of broken list. E.g. [["A", "B"], ["A", "C"]] messages b/n A<->B and A<->C will be dropped.',value:this.state.brokenLinks,onChange:this.handleBrokenLinksChange,multiline:!0,fullWidth:!0,rows:"10"}),Object(o.jsx)("br",{}),Object(o.jsx)(P.a,{label:"Sleep length in ticks",value:this.state.sleepTicks,onChange:this.handleSleepTicksChange,multiline:!1,fullWidth:!1,rows:"1"}),Object(o.jsx)(R.a,{value:this.state.nodeToSleep,onChange:this.handleNodeToSleepChange,children:this.state.nodes.map((function(e){return Object(o.jsx)(I.a,{value:e.name,children:e.name},e.name)}))}),Object(o.jsxs)(J.a,{variant:"contained",onClick:this.addSleepToNode,children:["Add sleep to ",this.state.nodeToSleep]}),Object(o.jsx)("br",{})]})}}]),n}(a.a.Component),D=function(e){e&&e instanceof Function&&n.e(3).then(n.bind(null,123)).then((function(t){var n=t.getCLS,o=t.getFID,s=t.getFCP,a=t.getLCP,r=t.getTTFB;n(e),o(e),s(e),a(e),r(e)}))};i.a.render(Object(o.jsx)(a.a.StrictMode,{children:Object(o.jsx)(F,{})}),document.getElementById("root")),D()}},[[70,1,2]]]);
//# sourceMappingURL=main.fe0e43c5.chunk.js.map